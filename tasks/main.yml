# Copyright 2018-2023 Chris Croome
#
# This file is part of the Webarchitects MariaDB Ansible role.
#
# The Webarchitects MariaDB Ansible role is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
#
# The Webarchitects MariaDB Ansible role is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with the Webarchitects MariaDB Ansible role. If not, see <https://www.gnu.org/licenses/>.
---
- name: MariaDB
  block:

    - name: MariaDB include verify tasks
      ansible.builtin.include_tasks: verify.yml
      when:
        - mariadb_verify is defined
        - mariadb_verify | bool
      tags:
        - mariadb_verify

    - name: MariaDB local facts tasks
      block:

        - name: Include apt role local fact tasks
          ansible.builtin.include_role:
            name: apt
            tasks_from: local_facts.yml
          when: >-
            ( ansible_local.bash.path is not defined ) or
            ( ansible_local.dpkg.installed is not defined )

        - name: Legacy /etc/ansible/facts.d/mariadb_root.fact file absent
          ansible.builtin.file:
            path: /etc/ansible/facts.d/mariadb_root.fact
            state: absent
          register: mariadb_root_fact

        - name: Re-read Ansible local facts  # noqa: no-handler
          ansible.builtin.setup:
            filter: ansible_local
          when: mariadb_root_fact.changed | bool

      tags:
        - mariadb_local_facts

    - name: Install MariaDB
      block:

        - name: Packages mariadb-server, mariadb-client and others present
          ansible.builtin.apt:
            pkg: "{{ mariadb_pkgs }}"
            state: present
            update_cache: false
          when:
            - mariadb_pkgs is defined
            - mariadb_pkgs != []
            - mariadb_pkgs | difference(ansible_local.dpkg.installed) != []
          register: mariadb_install
          notify: Restart mariadb

        - name: Include local facts tasks
          ansible.builtin.include_tasks: local_facts.yml
          when: (mariadb_install is defined) and (mariadb_install.changed | bool)

      tags:
        - mariadb_install

    - name: Configure MariaDB
      block:

        - name: Include the MariaDB configuration file tasks
          ansible.builtin.include_tasks: conf.yml
          loop: "{{ mariadb_config }}"
          loop_control:
            loop_var: mariadb_cnf
            label: "{{ mariadb_cnf.name | default(mariadb_cnf.path) }}"
          when:
            - mariadb_config is defined
            - mariadb_config != []
          tags:
            - mariadb_conf

    #    - name: MariaDB server defaults in place
    #      ansible.builtin.template:
    #        src: templates/50-server.cnf.j2
    #        dest: /etc/mysql/mariadb.conf.d/50-server.cnf
    #        owner: root
    #        group: root
    #        mode: 0644
    #      notify: Restart mariadb
    #
    #    - name: MariaDB client defaults in place
    #      ansible.builtin.template:
    #        src: templates/50-client.cnf.j2
    #        dest: /etc/mysql/mariadb.conf.d/50-client.cnf
    #        owner: root
    #        group: root
    #        mode: 0644
    #
    #    - name: MariaDB mysqldump defaults in place
    #      ansible.builtin.template:
    #        src: templates/mysqldump.cnf.j2
    #        dest: /etc/mysql/conf.d/mysqldump.cnf
    #        owner: root
    #        group: root
    #        mode: 0644
    #
    #    - name: MariaDB Systemd directory present
    #      ansible.builtin.file:
    #        path: /etc/systemd/system/mariadb.service.d
    #        state: directory
    #        owner: root
    #        group: root
    #        mode: 0755
    #
    #    - name: MariaDB Systemd drop-in file in place
    #      ansible.builtin.template:
    #        src: templates/mariadb.conf.j2
    #        dest: /etc/systemd/system/mariadb.service.d/mariadb.conf
    #        owner: root
    #        group: root
    #        mode: 0644
    #      notify:
    #        - Reload systemd
    #        - Restart mariadb

        - name: Include the MariaDB sys schema tasks
          ansible.builtin.include_tasks: sys.yml
          when: (mariadb_sys_schema | bool) and ("sys" not in mariadb_databases)

        - name: Run mysql_upgrade
          ansible.builtin.command: mysql_upgrade
          register: mariadb_upgrade
          changed_when: ("This installation of MariaDB is already upgraded" not in mariadb_upgrade.stdout)

        - name: Stat /etc/mysql/my.cnf
          ansible.builtin.stat:
            path: /etc/mysql/my.cnf
          register: mariadb_etc_my_cnf

        - name: Conditionally include the update-alternatives tasks
          ansible.builtin.include_tasks: update.yml
          when: (mariadb_etc_my_cnf is defined) and (not mariadb_etc_my_cnf.stat.islnk | bool)

        - name: Conditionally import the time zone tables import tasks
          ansible.builtin.include_tasks: tz.yml
          when: (mariadb_time_zone_import is defined) and (mariadb_time_zone_import | bool)

        - name: Conditionally include the user and database creation tasks
          ansible.builtin.include_tasks: mariadb_user.yml
          when: (mariadb_username is defined) and (mariadb_username | length > 0)

        - name: Include mysqltuner tasks
          ansible.builtin.include_tasks: mysqltuner.yml
          when: mariadb_mysqltuner | bool

      when:
        - ansible_local.dpkg.installed is defined
        - ( "mariadb-server" in ansible_local.dpkg.installed )

  when: mariadb | bool
  tags:
    - mariadb
...
