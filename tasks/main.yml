---
- name: Install and configure MariaDB
  block:

    - name: mariadb-server, mariadb-client and other packages present
      ansible.builtin.apt:
        pkg:
          - mariadb-client
          - mariadb-server
          - mycli
          - pwgen
          - python3-mysqldb
        state: present
        update_cache: false
      notify: Restart mariadb

    - name: python-mysqldb present on Debian Jessie and Stretch
      ansible.builtin.apt:
        pkg:
          - python-mysqldb
        state: present
        update_cache: false
      notify: Restart mariadb
      when: ansible_distribution_release is regex('^jessie|stretch$')

    - name: Include local facts tasks
      include_tasks: local_facts.yml

    - name: Tasks when the current root authentication method is a socket
      block:

        - name: Query the MariaDB databases, users and version using a socket and the community.mysql.mysql_info module
          include_tasks: info_socket.yml

        - name: Include the MariaDB root password authentication tasks
          ansible.builtin.include_tasks: mariadb_root_password.yml
          when: ( mariadb_root_auth is defined ) and ( mariadb_root_auth == "password" )

      when: mariadb_root_auth_current == "socket"

    - name: Tasks when the current root authentication method is a password
      block:

        - name: Query the MariaDB databases, users and version using a password and the command module
          include_tasks: info_password.yml

        - name: Include the MariaDB root user socket authentication tasks
          ansible.builtin.include_tasks: mariadb_root_socket.yml
          when: ( mariadb_root_auth is defined ) and ( mariadb_root_auth == "socket" )

      when: mariadb_root_auth_current == "password"

    - name: MariaDB server defaults in place
      ansible.builtin.template:
        src: templates/50-server.cnf.j2
        dest: /etc/mysql/mariadb.conf.d/50-server.cnf
        owner: root
        group: root
        mode: 0644
      notify: Restart mariadb

    - name: MariaDB client defaults in place
      ansible.builtin.template:
        src: templates/50-client.cnf.j2
        dest: /etc/mysql/mariadb.conf.d/50-client.cnf
        owner: root
        group: root
        mode: 0644

    - name: MariaDB mysqldump defaults in place
      ansible.builtin.template:
        src: templates/mysqldump.cnf.j2
        dest: /etc/mysql/conf.d/mysqldump.cnf
        owner: root
        group: root
        mode: 0644

    - name: MariaDB Systemd directory present
      ansible.builtin.file:
        path: /etc/systemd/system/mariadb.service.d
        state: directory
        owner: root
        group: root
        mode: 0755

    - name: MariaDB Systemd drop-in file in place
      ansible.builtin.template:
        src: templates/mariadb.conf.j2
        dest: /etc/systemd/system/mariadb.service.d/mariadb.conf
        owner: root
        group: root
        mode: 0644
      notify:
        - Reload systemd
        - Restart mariadb

    - name: Include the MariaDB sys schema tasks
      ansible.builtin.include_tasks: sys.yml
      when: ( mariadb_sys_schema | bool ) and ( "sys" not in mariadb_databases )

    - name: Run mysql_upgrade
      ansible.builtin.command: mysql_upgrade
      register: mariadb_upgrade
      changed_when: ( "This installation of MariaDB is already upgraded" not in mariadb_upgrade.stdout )

    - name: Stat /etc/mysql/my.cnf
      ansible.builtin.stat:
        path: /etc/mysql/my.cnf
      register: mariadb_etc_my_cnf

    - name: Conditionally include the update-alternatives tasks
      ansible.builtin.include_tasks: update.yml
      when: ( mariadb_etc_my_cnf is defined ) and ( not mariadb_etc_my_cnf.stat.islnk | bool )

    - name: Conditionally import the time zone tables import tasks
      ansible.builtin.include_tasks: tz.yml
      when: ( mariadb_time_zone_import is defined ) and ( mariadb_time_zone_import | bool )

    - name: Conditionally include the user and database creation tasks
      ansible.builtin.include_tasks: mariadb_user.yml
      when: ( mariadb_username is defined ) and ( mariadb_username | length > 0 )

    - name: Include mysqltuner tasks
      include_tasks: mysqltuner.yml
      when: mariadb_mysqltuner | bool

  when: mariadb | bool
  tags:
    - mariadb
...
