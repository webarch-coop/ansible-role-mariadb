---
- name: mariadb-server, mariadb-client and other packages present
  apt:
    pkg:
      - mariadb-client
      - mariadb-server
      - mysqltuner
      - pwgen
      - python-mysqldb
      - python3-mysqldb
      - python-pymysql
      - python3-pymysql
    state: present
    update_cache: false
  tags:
    - mariadb

- name: MariaDB defaults set
  template:
    src: templates/50-server.cnf.j2
    dest: /etc/mysql/mariadb.conf.d/50-server.cnf
    backup: true
  register: mariadb_conf
  tags:
    - mariadb

- name: MariaDB Systemd directory present
  file:
    path: /etc/systemd/system/mariadb.service.d
    state: directory
  tags:
    - mariadb

- name: MariaDB Systemd drop-in file in place
  template:
    src: templates/mariadb.conf.j2
    dest: /etc/systemd/system/mariadb.service.d/mariadb.conf
  register: mariadb_systemd
  tags:
    - mariadb

- name: MariaDB restarted
  systemd:
    name: mysql
    state: restarted
    daemon_reload: true
  when: ( mariadb_conf.changed ) or ( mariadb_systemd.changed )
  tags:
    - mariadb

- name: Conditionally include the root password tasks
  include_tasks: mariadb_root.yml
  when: ( mariadb_root_password is defined ) and ( mariadb_root_password | length > 0 )
  tags:
    - mariadb

- name: Conditionally import the time zone tables import tasks
  include_tasks: tz.yml
  when: ( mariadb_time_zone_import is defined ) and ( mariadb_time_zone_import | bool == True )
  tags:
    - mariadb

- name: Conditionally include the user and database creation tasks
  include_tasks: mariadb_user.yml
  when: ( mariadb_username is defined ) and ( mariadb_username | length > 0 )
  tags:
    - mariadb
...
