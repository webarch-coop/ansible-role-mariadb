---
- name: Install and configure MariaDB
  block:

    - name: Check the current auth method
      ansible.builtin.command: mysql -uroot -BNe "SELECT Plugin FROM user WHERE User='root'" mysql
      check_mode: false
      changed_when: false
      register: mariadb_root_auth_plugin

    - name: Debug
      debug:
        var: mariadb_root_auth_plugin

    - name: Check the current auth method
      community.mysql.mysql_query:
        query: "SELECT plugin FROM user WHERE User='root'"
        login_db: mysql
        login_user: root  
        # login_password: "{{ mariadb_root_password }}"
        login_unix_socket: /run/mysqld/mysqld.sock
      register: mariadb_root_auth_plugin

    - name: Debug
      debug:
        var: mariadb_root_auth_plugin

    - name: Set a variable for root authentication method
      set_fact:
        mariadb_root_auth_current: "{{ mariadb_root_auth_plugin.query_result }}"

    - name: Debug
      debug:
        var: mariadb_root_auth_current

    - name: Set a variable for root authentication method
      set_fact:
        mariadb_root_auth_current: "{{ result | map(attribute='plugin') }}"
      loop: "{{ mariadb_root_auth_plugin.query_result }}"
      loop_control:
        loop_var: result

    - name: Debug
      debug:
        var: mariadb_root_auth_current

    - name: Debug fail
      fail:

    - name: mariadb-server, mariadb-client and other packages present
      ansible.builtin.apt:
        pkg:
          - mariadb-client
          - mariadb-server
          - mycli
          - mysqltuner
          - pwgen
          - python3-mysqldb
        state: present
        update_cache: false

    - name: python-mysqldb present on Debian Jessie and Stretch
      ansible.builtin.apt:
        pkg:
          - python-mysqldb
        state: present
        update_cache: false
      when: ansible_distribution_release is regex('jessie|stretch')

    - name: Stat /root/.my.cnf
      ansible.builtin.stat:
        path: /root/.my.cnf
      register: mariadb_root_mycnf

    - name: Query the MariaDB version and databases using the /root/.my.cnf file
      community.mysql.mysql_info:
        filter:
          - databases
          - version
        config_file: /root/.my.cnf
        login_user: root
        login_host: localhost
        login_port: 3306
      register: mariadb_info
      when: mariadb_root_mycnf.stat.exists

    - name: Query the MariaDB version and databases using a socket
      community.mysql.mysql_info:
        filter:
          - databases
          - version
        login_user: root
        login_unix_socket: /run/mysqld/mysqld.sock
      register: mariadb_info
      when: not mariadb_root_mycnf.stat.exists

    - name: Debug MariaDB info
      ansible.builtin.debug:
        var: mariadb_info
        verbosity: 3

    - name: Set a variable for the MariaDB version
      ansible.builtin.set_fact:
        mariadb_version: "{{ mariadb_info.version.major }}.{{ mariadb_info.version.minor }}.{{ mariadb_info.version.release }}"

    - name: Debug MariaDB version
      ansible.builtin.debug:
        var: mariadb_version
        verbosity: 2

    - name: Set a variable for the MariaDB databases
      ansible.builtin.set_fact:
        mariadb_databases: "{{ mariadb_databases | default([]) }} + [ '{{ db.key }}' ]"
      loop: "{{ mariadb_info.databases | dict2items }}"
      loop_control:
        loop_var: db
        label: "{{ db.key }}"

    - name: Debug MariaDB databases
      ansible.builtin.debug:
        var: mariadb_databases
        verbosity: 2

    - name: MariaDB server defaults in place
      ansible.builtin.template:
        src: templates/50-server.cnf.j2
        dest: /etc/mysql/mariadb.conf.d/50-server.cnf
        owner: root
        group: root
        mode: 0644
      notify: Restart mariadb

    - name: MariaDB client defaults in place
      ansible.builtin.template:
        src: templates/50-client.cnf.j2
        dest: /etc/mysql/mariadb.conf.d/50-client.cnf
        owner: root
        group: root
        mode: 0644

    - name: MariaDB mysqldump defaults in place
      ansible.builtin.template:
        src: templates/mysqldump.cnf.j2
        dest: /etc/mysql/conf.d/mysqldump.cnf
        owner: root
        group: root
        mode: 0644

    - name: MariaDB Systemd directory present
      ansible.builtin.file:
        path: /etc/systemd/system/mariadb.service.d
        state: directory
        owner: root
        group: root
        mode: 0755

    - name: MariaDB Systemd drop-in file in place
      ansible.builtin.template:
        src: templates/mariadb.conf.j2
        dest: /etc/systemd/system/mariadb.service.d/mariadb.conf
        owner: root
        group: root
        mode: 0644
      notify:
        - Reload systemd
        - Restart mariadb

    - name: Include the MariaDB sys schema tasks
      ansible.builtin.include_tasks: sys.yml
      when: ( "sys" not in mariadb_databases )

    - name: Run mysql_upgrade
      ansible.builtin.command: mysql_upgrade
      register: mariadb_upgrade
      changed_when: ( "This installation of MariaDB is already upgraded" not in mariadb_upgrade.stdout )

    - name: Stat /etc/mysql/my.cnf
      ansible.builtin.stat:
        path: /etc/mysql/my.cnf
      register: mariadb_etc_my_cnf

    - name: Conditionally include the update-alternatives tasks
      ansible.builtin.include_tasks: update.yml
      when: ( mariadb_etc_my_cnf is defined ) and ( not mariadb_etc_my_cnf.stat.islnk )

    - name: Conditionally include the root password tasks
      ansible.builtin.include_tasks: mariadb_root.yml
      when: ( mariadb_root_auth is defined ) and ( mariadb_root_auth is regex("^password|socket$") )

    - name: Conditionally import the time zone tables import tasks
      ansible.builtin.include_tasks: tz.yml
      when: ( mariadb_time_zone_import is defined ) and ( mariadb_time_zone_import )

    - name: Conditionally include the user and database creation tasks
      ansible.builtin.include_tasks: mariadb_user.yml
      when: ( mariadb_username is defined ) and ( mariadb_username | length > 0 )

  when: mariadb
  tags:
    - mariadb
...
