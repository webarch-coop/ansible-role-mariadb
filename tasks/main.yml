---
- name: mariadb-server, mariadb-client and other packages present
  apt:
    pkg:
      - lsb_release
      - mariadb-server
      - mariadb-client
      - mysqltuner
      - python-mysqldb
      - python3-mysqldb
      - pwgen
    state: present
    update_cache: false
  tags:
    - mariadb

- name: Set a fact for the Debian version
  set_fact:
    mariadb_debian_version: "{{ ansible_distribution_release }}"
  tags:
    - mariadb

- name: Ensure that mariadb_debian_version is set
  block:

    - name: Set a fact for the Debian version
      set_fact:
            mariadb_debian_version: "{{ ansible_lsb.codename }}"
      when: ansible_lsb.codename is defined

    - block:

        - name: Get the Debian version
          command: lsb_release -c
          register: mariadb_lsb_release
          check_mode: false
          changed_when: false

        - name: Set a fact for the Debian version
          set_fact:
            mariadb_debian_version: "{{ mariadb_lsb_release.stdout.split(' ')[1] }}"

      when: ansible_lsb.codename is not defined

  when: ansible_distribution_release is not defined
  tags:
    - mariadb

- name: MariaDB defaults set
  template:
    src: templates/50-server.cnf.j2
    dest: /etc/mysql/mariadb.conf.d/50-server.cnf
    backup: true
  register: mariadb_conf
  tags:
    - mariadb

- name: MariaDB Systemd drop-in file in place
  template:
    src: templates/mariadb.conf.j2
    dest: /etc/systemd/system/mariadb.service.d/mariadb.conf
  register: mariadb_systemd
  tags:
    - mariadb

- name: MariaDB restarted
  systemd:
    name: mysql
    state: restarted
    daemon_reload: true
  when: ( mariadb_conf.changed ) or ( mariadb_systemd.changed )
  tags:
    - mariadb

- name: Conditionally include the root password tasks
  include_tasks: mariadb_root.yml
  when: ( mariadb_root_password is defined ) and ( mariadb_root_password != "" )
  tags:
    - mariadb

- name: Conditionally include the user and database creation tasks
  include_tasks: mariadb_user.yml
  when: ( mariadb_username is defined ) and ( mariadb_username != "" )
  tags:
    - mariadb
...
