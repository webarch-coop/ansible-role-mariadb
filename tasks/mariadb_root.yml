---
- name: Stat /root/.my.cnf
  stat:
    path: /root/.my.cnf
  register: root_mycnf_stat
  tags:
    - mariadb

# when mariadb_root_password equals "set", load the password from
# /root/.my.cnf if it exists and if not generate one
- block:

    - name: Load the passwd from /root/.my.cnf
      shell: "my_print_defaults --defaults-file='/root/.my.cnf' client | grep '^--password' | sed -e 's/--password=//'"
      register: mariadb_root_password_read
      when: root_mycnf_stat.stat.exists == True
      tags:
        - mariadb
     
    - name: Set a fact for the mariadb_root_password
      set_fact:
        mariadb_root_password: "{{ mariadb_root_password_read.stdout | trim | quote }}"
      when: root_mycnf_stat.stat.exists == True
      tags:
        - mariadb
     
    - name: Generate a random password for MariaDB root
      command: pwgen -n 16 1
      register: mariadb_root_password_gen
      when: root_mycnf_stat.stat.exists == False
      tags:
        - mariadb
    
    - name: Set a fact for the mariadb_root_password
      set_fact:
        mariadb_root_password: "{{ mariadb_root_password_gen.stdout | trim | quote }}"
      when: root_mycnf_stat.stat.exists == False
      tags:
        - mariadb
    
    - debug:
        msg: "mariadb_root_password: {{ mariadb_root_password }}"
        verbosity: 1
      tags:
        - mariadb

  when: mariadb_root_password == "set"

- debug:
    msg: "mariadb_root_password: {{ mariadb_root_password }}"
    verbosity: 1
  tags:
    - mariadb

# https://www.percona.com/blog/2016/03/16/change-user-password-in-mysql-5-7-with-plugin-auth_socket/
- name: Enable MariaDB root logins with a password
  command: mysql -uroot -p{{ mariadb_root_password }} -e "UPDATE mysql.user SET authentication_string=PASSWORD('{{ mariadb_root_password }}'), plugin='mysql_native_password' WHERE User='root' AND Host='localhost'; FLUSH PRIVILEGES;"
  register: mariadb_root_password_update
  tags:
    - mariadb

- debug:
    msg: "Results of MariaDB root password update: {{ mariadb_root_password_update.stdout }}"
    verbosity: 1
  tags:
    - mariadb

- name: "mariadb_root_password written to {{ mariadb_mycnf }}"
  template:
    src: templates/root.my.cnf.j2
    dest: /root/.my.cnf
    owner: root
    group: root
    mode: 0400
    force: true
  register: mariadb_root_password_written
  tags:
    - mariadb
