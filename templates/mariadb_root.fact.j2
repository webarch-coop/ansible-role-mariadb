#!/usr/bin/env bash
# {{ ansible_managed }}

set -euo pipefail

jo_path="$(type -p jo)"
mariadb_path="{{ mariadb_path }}"
mariadb_host="{{ mariadb_host }}"
mariadb_port="{{ mariadb_port }}"
tr_path="$(type -p tr)"
uid="$(id -u)"
wc_path="$(type -p wc)"

if [[ "${uid}" == 0 && -e "${mariadb_path}" ]]; then

  plugin=$("${mariadb_path}" -h "${mariadb_host}" -P "${mariadb_port}" -BNe "SELECT plugin FROM user WHERE Host='${mariadb_host}' AND User='root'" mysql)
  # shellcheck disable=SC2155
  declare -i NO=$(echo "${plugin}" | "${wc_path}" -l)

  if (( NO == 1 )); then
    "${jo_path}" state=present plugin="${plugin}"
  elif (( NO > 1 )); then
    # shellcheck disable=SC2046
    "${jo_path}" state=present plugin=$("${jo_path}" -a $(echo "${plugin}" | "${tr_path}" '\n' ' '))
  else
    echo "Sorry $0 was unable to find the MariaDB root authentication plugin(s)"
    echo 1
  fi

else
  "{jo}" state=absent
fi

# vim: syntax=bash
